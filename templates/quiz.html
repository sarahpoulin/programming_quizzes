<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <div class="container">
        <div class="quiz-header">
            <h1 id="quizTitle">Loading...</h1>
            <div class="progress-info">
                <span class="phase-badge" id="phaseBadge">Main</span>
                <span class="question-counter" id="questionCounter">Question 1 of 1</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="quiz-content">
            <div class="question-section">
                <h2 class="question-text" id="questionText">Loading question...</h2>
            </div>

            <form id="answerForm" class="answer-section">
                <!-- Answer options will be populated by JavaScript -->
            </form>

            <div id="feedback" class="feedback hidden">
                <div id="feedbackContent"></div>
            </div>

            <div class="button-section">
                <button id="submitBtn" class="btn btn-primary">Submit Answer</button>
                <button id="nextBtn" class="btn btn-next hidden">Next Question →</button>
            </div>
        </div>
    </div>

    <script>
        let quizState = null;
        let shuffledQuiz = null;
        let answered = false;
        let inlineInput = null;

        // Load quiz data on page load
        async function loadQuizData() {
            try {
                // Get shuffled quiz from localStorage
                const shuffledQuizJSON = localStorage.getItem('currentShuffledQuiz');
                if (!shuffledQuizJSON) {
                    alert('No quiz data found. Returning to quiz selector.');
                    window.location.href = '/';
                    return;
                }

                shuffledQuiz = JSON.parse(shuffledQuizJSON);

                // Get current quiz state from server
                const response = await fetch('/api/get_quiz_state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ shuffledQuiz: shuffledQuiz })
                });

                const data = await response.json();

                // Check for redirects
                if (data.redirect) {
                    if (data.redirect.includes('results')) {
                        // Store quiz data for results page
                        localStorage.setItem('resultsQuizData', JSON.stringify(data.quizData || shuffledQuiz));
                    }
                    window.location.href = data.redirect;
                    return;
                }

                if (data.error) {
                    alert('Error: ' + data.error);
                    window.location.href = '/';
                    return;
                }

                quizState = data;
                renderQuizQuestion();

            } catch (error) {
                console.error('Error loading quiz:', error);
                alert('Error loading quiz: ' + error.message);
                window.location.href = '/';
            }
        }

        function renderQuizQuestion() {
            // Update header
            document.getElementById('quizTitle').textContent = quizState.quiz_title;
            document.getElementById('phaseBadge').textContent = quizState.phase;
            document.getElementById('questionCounter').textContent = `Question ${quizState.question_num} of ${quizState.total_questions}`;
            document.getElementById('pageTitle').textContent = quizState.quiz_title;

            // Update progress bar
            const percentage = (quizState.question_num / quizState.total_questions) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';

            // Update question text
            document.getElementById('questionText').innerHTML = quizState.current_question.question;

            // Render answer options based on question type
            const answerForm = document.getElementById('answerForm');
            answerForm.innerHTML = '';

            if (quizState.question_type === 'multiple_choice') {
                renderMultipleChoice(answerForm, quizState.current_question.options);
            } else if (quizState.question_type === 'multiple_answer') {
                renderMultipleAnswer(answerForm, quizState.current_question.options);
            } else if (quizState.is_inline_blank) {
                renderInlineBlank();
            } else {
                renderFillInBlank(answerForm);
            }

            // Highlight code blocks
            highlightCode();
        }

        function renderMultipleChoice(form, options) {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            for (const [index, option] of Object.entries(options)) {
                const label = document.createElement('label');
                label.className = 'option-label';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'answer';
                input.value = index;
                input.className = 'option-input';

                const span = document.createElement('span');
                span.className = 'option-text';
                span.innerHTML = option;

                label.appendChild(input);
                label.appendChild(span);
                optionsDiv.appendChild(label);
            }

            form.appendChild(optionsDiv);
        }

        function renderMultipleAnswer(form, options) {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            for (const [index, option] of Object.entries(options)) {
                const label = document.createElement('label');
                label.className = 'option-label';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'answer';
                input.value = index;
                input.className = 'option-input option-checkbox';

                const span = document.createElement('span');
                span.className = 'option-text';
                span.innerHTML = option;

                label.appendChild(input);
                label.appendChild(span);
                optionsDiv.appendChild(label);
            }

            form.appendChild(optionsDiv);
        }

        function renderInlineBlank() {
            const questionText = document.getElementById('questionText');
            let questionHTML = questionText.innerHTML;

            // Replace ___blank___ or [blank] with an input field
            questionHTML = questionHTML.replace(/___blank___|\[blank\]/gi,
                '<span class="inline-blank-container"><input type="text" class="inline-blank-input" id="inlineBlankInput" autocomplete="off"></span>');

            questionText.innerHTML = questionHTML;
            inlineInput = document.getElementById('inlineBlankInput');

            if (inlineInput) {
                // Focus on the input field
                setTimeout(() => inlineInput.focus(), 100);

                // Allow Enter key to submit
                inlineInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('submitBtn').click();
                    }
                });
            }
        }

        function renderFillInBlank(form) {
            const div = document.createElement('div');
            div.className = 'fill-in-blank';

            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'blankInput';
            input.name = 'answer';
            input.className = 'blank-input';
            input.placeholder = 'Type your answer here...';
            input.autocomplete = 'off';

            // Allow Enter key to submit
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('submitBtn').click();
                }
            });

            div.appendChild(input);
            form.appendChild(div);

            setTimeout(() => input.focus(), 100);
        }

        // Submit answer
        document.getElementById('submitBtn').addEventListener('click', async () => {
            if (answered) return;

            let selectedAnswer;

            if (quizState.question_type === 'multiple_choice') {
                const selected = document.querySelector('input[name="answer"]:checked');
                if (!selected) {
                    alert('Please select an answer');
                    return;
                }
                selectedAnswer = selected.value;
            } else if (quizState.question_type === 'multiple_answer') {
                const checkedBoxes = document.querySelectorAll('input[name="answer"]:checked');
                if (checkedBoxes.length === 0) {
                    alert('Please select at least one answer');
                    return;
                }
                selectedAnswer = Array.from(checkedBoxes).map(cb => cb.value);
            } else if (quizState.is_inline_blank) {
                selectedAnswer = inlineInput ? inlineInput.value.trim() : '';
                if (!selectedAnswer) {
                    alert('Please enter an answer');
                    return;
                }
            } else {
                selectedAnswer = document.getElementById('blankInput').value.trim();
                if (!selectedAnswer) {
                    alert('Please enter an answer');
                    return;
                }
            }

            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        answer: selectedAnswer,
                        quizData: shuffledQuiz
                    })
                });

                const data = await response.json();

                // Display feedback
                let feedbackHTML = '';
                if (data.is_correct) {
                    feedbackHTML = `
                        <div class="feedback-correct">
                            ✓ Correct!
                        </div>
                    `;
                } else {
                    feedbackHTML = `
                        <div class="feedback-incorrect">
                            ✗ Incorrect
                        </div>
                        <div class="correct-answer">
                            <strong>Correct answer:</strong> ${data.correct_answer_text}
                        </div>
                    `;
                }

                document.getElementById('feedbackContent').innerHTML = feedbackHTML;
                document.getElementById('feedback').classList.remove('hidden');

                answered = true;
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('nextBtn').classList.remove('hidden');
                document.getElementById('answerForm').style.pointerEvents = 'none';
                document.getElementById('answerForm').style.opacity = '0.6';

                // Disable inline input if it exists
                if (inlineInput) {
                    inlineInput.disabled = true;
                    inlineInput.style.opacity = '0.6';
                }

            } catch (error) {
                alert('Error submitting answer: ' + error.message);
            }
        });

        // Next question
        document.getElementById('nextBtn').addEventListener('click', async () => {
            try {
                await fetch('/next_question', {
                    method: 'POST'
                });
                location.reload();
            } catch (error) {
                alert('Error moving to next question: ' + error.message);
            }
        });

        function highlightCode() {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // Load quiz on page load
        document.addEventListener('DOMContentLoaded', loadQuizData);
    </script>

    <!-- Highlight.js JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</body>
</html>